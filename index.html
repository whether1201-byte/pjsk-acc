<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÌîÑÎ°úÏÑ∏Ïπ¥ Ï†ïÌôïÎèÑ Í∏∞Î°ùÍ∏∞</title>

<style>
body {
  background: linear-gradient(180deg, #0d0d0d, #1a1a1a);
  color:#eee;
  font-family: "Segoe UI", Arial, sans-serif;
  padding:16px;
}

input, select, button {
  padding:8px;
  margin:4px 0;
  background:#1f1f1f;
  color:#fff;
  border:1px solid #444;
  border-radius:6px;
}

.song-card {
  background:#181818;
  border-radius:10px;
  padding:10px 12px;
  margin-top:14px;
}

.song-title {
  display:flex;
  align-items:center;
  font-weight:bold;
}

.record {
  margin-top:6px;
  padding-left:10px;
  display:flex;
  align-items:center;
  gap:8px;
}

.badge {
  padding:2px 6px;
  border-radius:6px;
  font-size:12px;
  font-weight:bold;
}

.EASY { background:#2e7d32; }
.NORMAL { background:#558b2f; }
.HARD { background:#ef6c00; }
.EXPERT { background:#c62828; }
.MASTER { background:#6a1b9a; }
.APPEND { background:#0277bd; }

.acc { font-weight:bold; }
.AP { color:#ffd700; }
.FC { color:#9cff57; }

.icon-btn {
  background:none;
  border:none;
  color:#aaa;
  cursor:pointer;
}

.delete {
  color:#ff5252;
}
</style>
</head>

<body>

<h2>ÌîÑÎ°úÏÑ∏Ïπ¥ Ï†ïÌôïÎèÑ Í∏∞Î°ùÍ∏∞</h2>

<select id="userSelect" onchange="switchUser()"></select>
<input id="newUser" placeholder="ÏÉà Ïú†Ï†Ä">
<button onclick="addUser()">Ï∂îÍ∞Ä</button>
<button onclick="clearAll()">Ïú†Ï†Ä Í∏∞Î°ù Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>

<hr>

<input id="song" placeholder="ÎÖ∏Îûò Ïù¥Î¶Ñ" list="songList">
<datalist id="songList"></datalist>

<select id="diff">
  <option>APPEND</option>
  <option>MASTER</option>
  <option>EXPERT</option>
  <option>HARD</option>
  <option>NORMAL</option>
  <option>EASY</option>
</select>

<input id="level" placeholder="Í∏∞Î≥∏ ÎÇúÏù¥ÎèÑ">
<input id="detail" placeholder="ÏÑ∏Î∂Ä ÎÇúÏù¥ÎèÑ (Ïòà: 27+/27.4)">

<hr>

PERFECT <input id="p" type="number"><br>
GREAT <input id="g" type="number"><br>
GOOD <input id="d" type="number"><br>
BAD <input id="b" type="number"><br>
MISS <input id="m" type="number"><br>

<button onclick="calculate()">Ï†ÄÏû•</button>

<hr>

<select id="filterMode" onchange="render()">
  <option value="all">Ï†ÑÏ≤¥ Î≥¥Í∏∞</option>
  <option value="FC">FCÎßå Î≥¥Í∏∞</option>
  <option value="AP">APÎßå Î≥¥Í∏∞</option>
</select>

<div id="records"></div>

<script>
let db = JSON.parse(localStorage.getItem("pskDB") || "{}");
let songOrder = JSON.parse(localStorage.getItem("songOrder") || "[]");
let currentUser = localStorage.getItem("currentUser") || "default";

function saveDB(){
  localStorage.setItem("pskDB", JSON.stringify(db));
  localStorage.setItem("songOrder", JSON.stringify(songOrder));
}
function userData(){
  if(!db[currentUser]) db[currentUser]={};
  return db[currentUser];
}

/* Ïú†Ï†Ä */
function initUsers(){
  userSelect.innerHTML="";
  Object.keys(db).forEach(u=>{
    let o=document.createElement("option");
    o.value=o.text=u;
    if(u===currentUser) o.selected=true;
    userSelect.appendChild(o);
  });
}
function addUser(){
  const n=newUser.value.trim();
  if(!n) return;
  if(!db[n]) db[n]={};
  currentUser=n;
  localStorage.setItem("currentUser",n);
  saveDB(); initUsers(); render();
}
function switchUser(){
  currentUser=userSelect.value;
  localStorage.setItem("currentUser",currentUser);
  render();
}

/* Ï†ïÌôïÎèÑ */
function calcAccuracy(p,g,d,b,m){
  const N=p+g+d+b+m;
  if(!N) return 0;
  return Math.max(0,(1-(g+2.5*d+4*b+8*m)/N))*100;
}

/* Ï†ÄÏû• */
function calculate(){
  const song=songInput.value.trim();
  if(!song) return;

  const diff=diffSelect.value;
  const level=levelInput.value.trim();
  const detail=detailInput.value.trim();

  const p=+pInput.value, g=+gInput.value, d=+dInput.value, b=+bInput.value, m=+mInput.value;
  const acc=calcAccuracy(p,g,d,b,m);

  let judge="NONE";
  if(g===0 && d===0 && b===0 && m===0) judge="AP";
  else if(d===0 && b===0 && m===0) judge="FC";

  const data=userData();
  if(!data[song]){
    data[song]={};
    songOrder.unshift(song);
  }

  data[song][diff]={acc,judge,level,detail};
  saveDB(); render();
}

/* ÏÇ≠Ï†ú */
function deleteDiff(song,diff){
  if(!confirm(`${song} [${diff}] Í∏∞Î°ù ÏÇ≠Ï†ú?`)) return;
  delete userData()[song][diff];
  if(Object.keys(userData()[song]).length===0){
    deleteSong(song,false);
  }
  saveDB(); render();
}
function deleteSong(song,ask=true){
  if(ask && !confirm(`"${song}" Ï†ÑÏ≤¥ Í∏∞Î°ù ÏÇ≠Ï†ú?`)) return;
  delete userData()[song];
  songOrder=songOrder.filter(s=>s!==song);
  saveDB(); render();
}
function clearAll(){
  if(!confirm(`${currentUser}Ïùò Î™®Îì† Í∏∞Î°ù ÏÇ≠Ï†ú?`)) return;
  db[currentUser]={};
  songOrder=[];
  saveDB(); render();
}

/* ÏàúÏÑú */
function moveSong(song,dir){
  const i=songOrder.indexOf(song);
  const ni=i+dir;
  if(ni<0||ni>=songOrder.length) return;
  [songOrder[i],songOrder[ni]]=[songOrder[ni],songOrder[i]];
  saveDB(); render();
}

/* Ï∂úÎ†• */
const diffOrder=["APPEND","MASTER","EXPERT","HARD","NORMAL","EASY"];

function render(){
  records.innerHTML="";
  songList.innerHTML="";
  const data=userData();
  const filter=filterMode.value;

  songOrder.forEach(song=>{
    if(!data[song]) return;

    let rows="";
    diffOrder.forEach(d=>{
      const r=data[song][d];
      if(!r) return;

      if(filter==="AP" && r.judge!=="AP") return;
      if(filter==="FC" && !(r.judge==="FC" || r.judge==="AP")) return;

      rows+=`
        <div class="record">
          <span class="badge ${d}">
            ${d} ${r.level}${r.detail?` (${r.detail})`:""}
          </span>
          <span class="acc ${r.judge}">
            ${r.acc.toFixed(6)}%${r.judge!=="NONE"?` (${r.judge})`:""}
          </span>
          <button class="icon-btn delete" onclick="deleteDiff('${song}','${d}')">‚úñ</button>
        </div>`;
    });

    if(!rows) return;

    records.innerHTML+=`
      <div class="song-card">
        <div class="song-title">
          ${song}
          <span style="margin-left:auto">
            <button class="icon-btn" onclick="moveSong('${song}',-1)">‚ñ≤</button>
            <button class="icon-btn" onclick="moveSong('${song}',1)">‚ñº</button>
            <button class="icon-btn delete" onclick="deleteSong('${song}')">üóë</button>
          </span>
        </div>
        ${rows}
      </div>`;

    let o=document.createElement("option");
    o.value=o.text=song;
    songList.appendChild(o);
  });
}

/* DOM */
const userSelect=document.getElementById("userSelect");
const newUser=document.getElementById("newUser");
const songInput=document.getElementById("song");
const diffSelect=document.getElementById("diff");
const levelInput=document.getElementById("level");
const detailInput=document.getElementById("detail");
const pInput=document.getElementById("p");
const gInput=document.getElementById("g");
const dInput=document.getElementById("d");
const bInput=document.getElementById("b");
const mInput=document.getElementById("m");
const records=document.getElementById("records");
const songList=document.getElementById("songList");
const filterMode=document.getElementById("filterMode");

initUsers();
render();
</script>

</body>
</html>

