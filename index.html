<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¦¬ë“¬ê²Œì„ ì •í™•ë„ ê¸°ë¡ê¸°</title>

<style>
body {
  background:#111;
  color:#eee;
  font-family: Arial, sans-serif;
  padding:20px;
}

input, select, button {
  padding:8px;
  margin:4px 0;
  background:#222;
  color:#fff;
  border:1px solid #555;
}

button { cursor:pointer; }

.song { margin-top:14px; font-weight:bold; }
.record { margin-left:18px; font-size:14px; }

.EASY { color:#4caf50; }
.NORMAL { color:#8bc34a; }
.HARD { color:#ff9800; }
.EXPERT { color:#f44336; }
.MASTER { color:#9c27b0; }
.APPEND { color:#03a9f4; }

.AP { color:#ffd700; }
.FC { color:#00e5ff; }
.delete { margin-left:6px; color:#ff5252; }
</style>
</head>

<body>

<h2>ğŸµ ë¦¬ë“¬ê²Œì„ ì •í™•ë„ ê¸°ë¡ê¸°</h2>

<!-- ìœ ì € -->
<h3>ğŸ‘¤ ìœ ì €</h3>
<select id="userSelect" onchange="switchUser()"></select>
<input id="newUser" placeholder="ìƒˆ ìœ ì €">
<button onclick="addUser()">ì¶”ê°€</button>

<hr>

<input id="song" placeholder="ë…¸ë˜ ì´ë¦„" list="songs">
<datalist id="songs"></datalist><br>

<select id="diff">
  <option>EASY</option>
  <option>NORMAL</option>
  <option>HARD</option>
  <option>EXPERT</option>
  <option>MASTER</option>
  <option>APPEND</option>
</select>

ë‚œì´ë„
<input id="level" type="number" min="1" max="40" style="width:70px">

<hr>

PERFECT <input id="p" type="number" min="0"><br>
GREAT <input id="g" type="number" min="0"><br>
GOOD <input id="d" type="number" min="0"><br>
BAD <input id="b" type="number" min="0"><br>
MISS <input id="m" type="number" min="0"><br>

<button onclick="calculate()">ì •í™•ë„ ê³„ì‚° & ì €ì¥</button>

<hr>

<select id="sortMode" onchange="render()">
  <option value="acc">ì •í™•ë„ ë†’ì€ ìˆœ</option>
  <option value="time">ìµœì‹  ê¸°ë¡ ìˆœ</option>
  <option value="level">ë‚œì´ë„ ë†’ì€ ìˆœ</option>
</select>

<button onclick="clearAll()">í˜„ì¬ ìœ ì € ê¸°ë¡ ì´ˆê¸°í™”</button>

<div id="result"></div>
<div id="records"></div>

<script>
/* ================= ìœ ì € ê´€ë¦¬ ================= */
let currentUser = localStorage.getItem("currentUser") || "default";

function loadUsers() {
  return JSON.parse(localStorage.getItem("users") || '["default"]');
}
function saveUsers(u) {
  localStorage.setItem("users", JSON.stringify(u));
}
function initUsers() {
  userSelect.innerHTML="";
  loadUsers().forEach(u=>{
    let o=document.createElement("option");
    o.value=u; o.text=u;
    if (u===currentUser) o.selected=true;
    userSelect.appendChild(o);
  });
}
function addUser() {
  const n=newUser.value.trim();
  if(!n) return;
  const u=loadUsers();
  if(!u.includes(n)) u.push(n);
  saveUsers(u);
  currentUser=n;
  localStorage.setItem("currentUser",n);
  initUsers(); render();
  newUser.value="";
}
function switchUser() {
  currentUser=userSelect.value;
  localStorage.setItem("currentUser",currentUser);
  render();
}

/* ================= ì •í™•ë„ ================= */
function calcAccuracy(p,g,d,b,m) {
  const N=p+g+d+b+m;
  if(!N) return 0;
  const penalty = g + 2.5*d + 4*b + 8*m;
  return Math.max(0,(1-penalty/N))*100;
}

/* ================= ì €ì¥ ================= */
function key() {
  return "records_"+currentUser;
}
function load() {
  return JSON.parse(localStorage.getItem(key()) || "{}");
}
function saveData(d) {
  localStorage.setItem(key(), JSON.stringify(d));
}

function calculate() {
  const song=songInput.value.trim();
  if(!song) return alert("ë…¸ë˜ ì´ë¦„ ì…ë ¥");

  const diff=diffSelect.value;
  const level=+levelInput.value||0;
  const p=+pInput.value, g=+gInput.value, d=+dInput.value, b=+bInput.value, m=+mInput.value;

  const acc=calcAccuracy(p,g,d,b,m);
  let judge="NONE";
  if(m===0&&b===0&&d===0&&g===0) judge="AP";
  else if(m===0) judge="FC";

  result.innerHTML=`<b class="${judge}">ì •í™•ë„: ${acc.toFixed(6)}% ${judge!=="NONE"?`(${judge})`:""}</b>`;

  const data=load();
  if(!data[song]) data[song]={};

  if(!data[song][diff]||acc>data[song][diff].acc){
    data[song][diff]={acc,judge,level,time:Date.now()};
  }

  saveData(data);
  render();
}

/* ================= ì‚­ì œ ================= */
function deleteSong(song) {
  if(!confirm(`"${song}"ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
  const d=load();
  delete d[song];
  saveData(d); render();
}

function deleteDiff(song,diff) {
  if(!confirm(`${song} [${diff}] ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
  const d=load();
  delete d[song][diff];
  if(Object.keys(d[song]).length===0) delete d[song];
  saveData(d); render();
}

function clearAll() {
  if(!confirm(`${currentUser}ì˜ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
  localStorage.removeItem(key());
  render();
}

/* ================= ì¶œë ¥ ================= */
const diffOrder={APPEND:0,MASTER:1,EXPERT:2,HARD:3,NORMAL:4,EASY:5};

function render() {
  records.innerHTML="";
  songs.innerHTML="";
  const data=load();
  let list=[];

  for(let s in data){
    let diffs=[],best=0,time=0,lvl=0;
    for(let d in data[s]){
      let r=data[s][d];
      diffs.push({diff:d,...r});
      best=Math.max(best,r.acc);
      time=Math.max(time,r.time);
      lvl=Math.max(lvl,r.level);
    }
    diffs.sort((a,b)=>diffOrder[a.diff]-diffOrder[b.diff]);
    list.push({song:s,best,time,lvl,diffs});

    let o=document.createElement("option");
    o.value=s; songs.appendChild(o);
  }

  const mode=sortMode.value;
  list.sort((a,b)=>mode==="acc"?b.best-a.best:mode==="time"?b.time-a.time:b.lvl-a.lvl);

  list.forEach(s=>{
    records.innerHTML+=`
      <div class="song">
        ${s.song}
        <button class="delete" onclick="deleteSong('${s.song}')">ğŸ—‘</button>
      </div>`;
    s.diffs.forEach(d=>{
      records.innerHTML+=`
        <div class="record ${d.diff} ${d.judge}">
          â”” [${d.diff} ${d.level}] ${d.acc.toFixed(6)}%
          ${d.judge!=="NONE"?`(${d.judge})`:""}
          <button class="delete" onclick="deleteDiff('${s.song}','${d.diff}')">âœ–</button>
        </div>`;
    });
  });
}

/* ================= DOM ================= */
const userSelect=document.getElementById("userSelect");
const newUser=document.getElementById("newUser");
const songInput=document.getElementById("song");
const diffSelect=document.getElementById("diff");
const levelInput=document.getElementById("level");
const pInput=document.getElementById("p");
const gInput=document.getElementById("g");
const dInput=document.getElementById("d");
const bInput=document.getElementById("b");
const mInput=document.getElementById("m");
const records=document.getElementById("records");
const songs=document.getElementById("songs");
const sortMode=document.getElementById("sortMode");
const result=document.getElementById("result");

initUsers();
render();
</script>

</body>
</html>