<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í”„ë¡œì„¸ì¹´ ì •í™•ë„ ê¸°ë¡ê¸°</title>

<style>
body {
  background: linear-gradient(180deg, #0d0d0d, #1a1a1a);
  color:#eee;
  font-family: "Segoe UI", Arial, sans-serif;
  padding:16px;
}

h2 { margin-bottom: 6px; }
h3 { margin-top: 14px; }

input, select, button {
  padding:8px;
  margin:4px 0;
  background:#1f1f1f;
  color:#fff;
  border:1px solid #444;
  border-radius:6px;
}

button {
  cursor:pointer;
  transition:0.2s;
}
button:hover {
  background:#333;
}

hr {
  border:none;
  border-top:1px solid #333;
  margin:14px 0;
}

/* ===== ì¹´ë“œ ===== */
.song-card {
  background:#181818;
  border-radius:10px;
  padding:10px 12px;
  margin-top:14px;
  box-shadow:0 0 6px rgba(0,0,0,0.4);
}

.song-title {
  font-weight:bold;
  font-size:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ===== ê¸°ë¡ ===== */
.record {
  margin-top:6px;
  padding-left:10px;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:8px;
}

/* ===== ë‚œì´ë„ ë°°ì§€ ===== */
.badge {
  padding:2px 6px;
  border-radius:6px;
  font-size:12px;
  font-weight:bold;
}

.EASY { background:#2e7d32; }
.NORMAL { background:#558b2f; }
.HARD { background:#ef6c00; }
.EXPERT { background:#c62828; }
.MASTER { background:#6a1b9a; }
.APPEND { background:#0277bd; }

/* ===== ì •í™•ë„ ===== */
.acc { font-weight:bold; }
.AP { color:#ffd700; }
.FC { color:#9cff57; }

/* ===== ë²„íŠ¼ ===== */
.delete {
  margin-left:auto;
  background:none;
  border:none;
  color:#ff5252;
  font-size:14px;
}

/* ===== ìƒë‹¨ ì»¨íŠ¸ë¡¤ ===== */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<h2>ğŸµ í”„ë¡œì„¸ì¹´ ì •í™•ë„ ê¸°ë¡ê¸°</h2>

<h3>ğŸ‘¤ ìœ ì €</h3>
<div class="controls">
  <select id="userSelect" onchange="switchUser()"></select>
  <input id="newUser" placeholder="ìƒˆ ìœ ì €">
  <button onclick="addUser()">ì¶”ê°€</button>
</div>

<hr>

<input id="song" placeholder="ë…¸ë˜ ì´ë¦„" list="songList">
<datalist id="songList"></datalist>

<div class="controls">
  <select id="diff">
    <option>EASY</option>
    <option>NORMAL</option>
    <option>HARD</option>
    <option>EXPERT</option>
    <option>MASTER</option>
    <option>APPEND</option>
  </select>

  <input id="level" type="number" min="1" max="40" placeholder="ë‚œì´ë„">
</div>

<hr>

PERFECT <input id="p" type="number" min="0"><br>
GREAT <input id="g" type="number" min="0"><br>
GOOD <input id="d" type="number" min="0"><br>
BAD <input id="b" type="number" min="0"><br>
MISS <input id="m" type="number" min="0"><br>

<button onclick="calculate()">ì •í™•ë„ ê³„ì‚° & ì €ì¥</button>

<hr>

<div class="controls">
  <select id="sortMode" onchange="render()">
    <option value="level" selected>ë‚œì´ë„ ë†’ì€ ìˆœ</option>
    <option value="acc">ì •í™•ë„ ë†’ì€ ìˆœ</option>
    <option value="time">ìµœì‹  ê¸°ë¡ ìˆœ</option>
  </select>

  <select id="filterMode" onchange="render()">
    <option value="all">ì „ì²´</option>
    <option value="FC">FCë§Œ</option>
    <option value="AP">APë§Œ</option>
  </select>

  <button onclick="clearAll()">ê¸°ë¡ ì´ˆê¸°í™”</button>
</div>

<div id="result"></div>
<div id="records"></div>

<script>
/* ===== DB ===== */
let db = JSON.parse(localStorage.getItem("pskDB") || "{}");
let currentUser = localStorage.getItem("currentUser") || "default";

function saveDB(){ localStorage.setItem("pskDB", JSON.stringify(db)); }
function userData(){ if(!db[currentUser]) db[currentUser]={}; return db[currentUser]; }

/* ===== ìœ ì € ===== */
function initUsers(){
  userSelect.innerHTML="";
  Object.keys(db).forEach(u=>{
    let o=document.createElement("option");
    o.value=u; o.text=u;
    if(u===currentUser) o.selected=true;
    userSelect.appendChild(o);
  });
}
function addUser(){
  const n=newUser.value.trim();
  if(!n) return;
  if(!db[n]) db[n]={};
  currentUser=n;
  localStorage.setItem("currentUser",n);
  saveDB(); initUsers(); render();
  newUser.value="";
}
function switchUser(){
  currentUser=userSelect.value;
  localStorage.setItem("currentUser",currentUser);
  render();
}

/* ===== ì •í™•ë„ ===== */
function calcAccuracy(p,g,d,b,m){
  const N=p+g+d+b+m;
  if(!N) return 0;
  const penalty = g + 2.5*d + 4*b + 8*m;
  return Math.max(0,(1-penalty/N))*100;
}

/* ===== ì €ì¥ ===== */
function calculate(){
  const song=songInput.value.trim();
  if(!song) return alert("ë…¸ë˜ ì´ë¦„ ì…ë ¥");

  const diff=diffSelect.value;
  const level=+levelInput.value||0;
  const p=+pInput.value, g=+gInput.value, d=+dInput.value, b=+bInput.value, m=+mInput.value;

  const acc=calcAccuracy(p,g,d,b,m);

  let judge="NONE";
  if(g===0 && d===0 && b===0 && m===0) judge="AP";
  else if(d===0 && b===0 && m===0) judge="FC";

  result.innerHTML=`<div class="acc ${judge}">ì •í™•ë„: ${acc.toFixed(6)}% ${judge!=="NONE"?`(${judge})`:""}</div>`;

  const data=userData();
  if(!data[song]) data[song]={};

  if(!data[song][diff] || acc>data[song][diff].acc){
    data[song][diff]={acc,judge,level,time:Date.now()};
  }

  saveDB();
  render();
}

/* ===== ì‚­ì œ ===== */
function deleteSong(song){
  if(!confirm(`"${song}" ì „ì²´ ì‚­ì œ?`)) return;
  delete userData()[song];
  saveDB(); render();
}
function deleteDiff(song,diff){
  if(!confirm(`${song} [${diff}] ì‚­ì œ?`)) return;
  delete userData()[song][diff];
  if(Object.keys(userData()[song]).length===0) delete userData()[song];
  saveDB(); render();
}
function clearAll(){
  if(!confirm(`${currentUser} ê¸°ë¡ ì „ë¶€ ì‚­ì œ?`)) return;
  db[currentUser]={};
  saveDB(); render();
}

/* ===== ì¶œë ¥ ===== */
const diffOrder={APPEND:0,MASTER:1,EXPERT:2,HARD:3,NORMAL:4,EASY:5};

function render(){
  records.innerHTML="";
  songList.innerHTML="";
  const data=userData();
  const sort = sortMode.value; 
  let list=[];

  for(let s in data){
    let diffs=[];
    for(let d in data[s]){
      diffs.push({song:s,diff:d,...data[s][d]});
    }
  diffs.sort((a,b)=>{
    // ë‚œì´ë„(EXPERT > HARD ë“±)
    if (diffOrder[a.diff] !== diffOrder[b.diff])
      return diffOrder[a.diff] - diffOrder[b.diff];

    // ê°™ì€ ë‚œì´ë„ë©´ ë ˆë²¨ (26 > 25)
    if (a.level !== b.level)
      return b.level - a.level;

    // ë‚œì´ë„ + ë ˆë²¨ê¹Œì§€ ê°™ìœ¼ë©´ ì •í™•ë„
    return b.acc - a.acc;
  });
    list.push({song:s,diffs});
      if (sort === "acc") {
    list.sort((a,b) =>
      Math.max(...b.diffs.map(d=>d.acc)) -
      Math.max(...a.diffs.map(d=>d.acc))
    );
  }
  else if (sort === "time") {
    list.sort((a,b) =>
      Math.max(...b.diffs.map(d=>d.time)) -
      Math.max(...a.diffs.map(d=>d.time))
    );
  }
  else if (sort === "level") {
    list.sort((a,b) =>
      Math.max(...b.diffs.map(d=>d.level)) -
      Math.max(...a.diffs.map(d=>d.level))
    );
  }
    let o=document.createElement("option");
    o.value=s; songList.appendChild(o);
  }

  const filter=filterMode.value;

  list.forEach(s=>{
    records.innerHTML+=`
      <div class="song-card">
        <div class="song-title">
          ${s.song}
          <button class="delete" onclick="deleteSong('${s.song}')">ğŸ—‘</button>
        </div>`;
    s.diffs.forEach(d=>{
      if (filter === "AP" && d.judge !== "AP") return;
      if (filter === "FC" && !(d.judge === "FC" || d.judge === "AP")) return;
      records.innerHTML+=`
        <div class="record">
          <span class="badge ${d.diff}">${d.diff} ${d.level}</span>
          <span class="acc ${d.judge}">${d.acc.toFixed(6)}%</span>
          ${d.judge!=="NONE"?`(${d.judge})`:""}
          <button class="delete" onclick="deleteDiff('${s.song}','${d.diff}')">âœ–</button>
        </div>`;
    });
    records.innerHTML+=`</div>`;
  });
}

/* ===== DOM ===== */
const userSelect=document.getElementById("userSelect");
const newUser=document.getElementById("newUser");
const songInput=document.getElementById("song");
const diffSelect=document.getElementById("diff");
const levelInput=document.getElementById("level");
const pInput=document.getElementById("p");
const gInput=document.getElementById("g");
const dInput=document.getElementById("d");
const bInput=document.getElementById("b");
const mInput=document.getElementById("m");
const records=document.getElementById("records");
const songList=document.getElementById("songList");
const sortMode=document.getElementById("sortMode");
const filterMode=document.getElementById("filterMode");
const result=document.getElementById("result");

initUsers();
render();
</script>

</body>
</html>
